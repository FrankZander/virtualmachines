<!-- Virtual Machine Creator -->
<!DOCTYPE html>
<html>
<head>
	<title>Request FME Virtual Machine</title>
	<!-- Styles for example -->
	<link rel="stylesheet" href="https://playground.fmeserver.com/css/FMEServerExamples.css" type="text/css" />
	<!-- Include FMEServer.js -->
	<script type="text/javascript" src="https://api.fmeserver.com/js/v3/FMEServer.js"></script>
</head>
<body>
	<form id="example-form">
		<input id="repository-name" type="hidden" value="FMETraining" name="repository" />
		<input id="workspace-name" type="hidden" value="PythonVMCreator.fmw" name="workspace" />
	</form>

	<script type="text/javascript">
		var repository, workspace, form;

		window.onload = function() {
			repository = document.getElementById( "repository-name" ).value;
			workspace = document.getElementById( "workspace-name" ).value;
			form = document.getElementById( "example-form" );

			FMEServer.init({
				server : "https://bluesky-safe-software.fmecloud.com",
				token : "0da8284a549462da314f97b336723e23178655d5"
			});

			// Get the workspace parameters from FME Server
			FMEServer.getWorkspaceParameters( repository, workspace, populateForm );
		};

		function populateForm( json ) {
			// Use the API to build the form items
			FMEServer.generateFormItems( "example-form", json );

			// Add the custom submit button
			var button = document.createElement( "input" );
			button.type = "button";
			button.value = "Request Virtual Machine";
			button.innerHTML = '<img src="libs\loading.gif" />';
			form.appendChild( button );
		}

		function showResults( json ) {
			// The following is to write out the full return object
			// for visualization of the example
			var hr = document.createElement( "hr" );
			var div = document.createElement( "div" );
			div.innerHTML = "<h4>Return Object:</h4><pre>"+JSON.stringify(json, undefined, 4)+"</pre>";
			document.body.appendChild( hr );
			document.body.appendChild( div );
		}

		function submitJob() {
			// Create the the publishedParameters array, and a checkboxes object
			var params = { "publishedParameters" : [] };
			var publishedParameters = params.publishedParameters;
			var checkboxes = {};
			
			var hr = document.createElement( "hr" );
			var div = document.createElement( "div" );
			div.innerHTML = "<H4>WORKING!<H4>";
			document.body.appendChild( hr );
			document.body.appendChild( div );

			// Loop through the form elements and build the publishedParameters array
			for( var i = 0; i < form.elements.length; i++ ){
				var element = form.elements[i];
				var obj = { "name" : "", "value" : null }
				obj.name = element.name;
				if( element.type == "select" ) {
					obj.value = element[element.selectedIndex].value;
					publishedParameters.push( obj );
				} else if( element.type == "checkbox" ){
					if( element.checked ) {
						if( !checkboxes[element.name] ){
							checkboxes[element.name] = [];
						}
						checkboxes[element.name].push( element.value );
					}
				} else if( element.type != "hidden" && element.type != "button" ) {
					obj.value = element.value;
					publishedParameters.push( obj );
				}
			}

			// Add all grouped checkbox elements to the published parameters
			for( name in checkboxes ) {
				publishedParameters.push( { "name" : name, "value" : checkboxes[name] } );
			}

			// Submit Job to FME Server and run synchronously
			FMEServer.submitSyncJob( repository, workspace, params, showResults );
		}

	</script>
</body>
</html>
