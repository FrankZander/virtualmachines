<!-- Virtual Machine Creator -->
<!DOCTYPE html>
<html>
<head>
	<title>Request FME Virtual Machine</title>
	<!-- Styles for example -->
	<link rel="stylesheet" href="https://playground.fmeserver.com/css/FMEServerExamples.css" type="text/css" />
	<!-- Include FMEServer.js -->
	<script type="text/javascript" src="https://api.fmeserver.com/js/v3/FMEServer.js"></script>
</head>
<body>
	<form id="example-form">
		<input id="repository-name" type="hidden" value="FMETraining" name="repository" />
		<input id="workspace-name" type="hidden" value="PythonVMCreator.fmw" name="workspace" />
	</form>

	<script type="text/javascript">
		var repository, workspace, form;

		window.onload = function() {
			repository = document.getElementById( "repository-name" ).value;
			workspace = document.getElementById( "workspace-name" ).value;
			form = document.getElementById( "example-form" );

			FMEServer.init({
				server : "https://bluesky-safe-software.fmecloud.com",
				token : "0da8284a549462da314f97b336723e23178655d5"
			});

			// Get the workspace parameters from FME Server
			FMEServer.getWorkspaceParameters( repository, workspace, populateForm );
		};

		function populateForm( json ) {
			// Use the API to build the form items
			FMEServer.generateFormItems( "example-form", json );

			// Add the custom submit button
			var button = document.createElement( "input" );
			button.id = "RequestButton";
			button.type = "button";
			button.value = "Request Virtual Machine";
			button.setAttribute( "onclick", "submitJob();" );
			form.appendChild( button );
			
			//Add and hide spinner for feedback when request is made
			var spinner = document.createElement("input");
			spinner.id = "spinner";
			spinner.type = "image";
			spinner.src = "https://s3.amazonaws.com/fmevm/libs/loading.gif";
			spinner.type = "hidden";
			form.appendChild(spinner);
		}

		function showResults( json ) {
			
			var resultText = json.status;
			var resultId = json.id;
 
			//hide spinner when results come in
			var spinner = document.getElementById("spinner");
			spinner.type = "hidden";
			
			//Show the request button again
			var button = document.getElementById("RequestButton");
			button.type = "button";
			
			
			// The following is to write out the full return object
			// for visualization of the example
			var hr = document.createElement( "hr" );
			var div = document.createElement( "div" );
			if(resultText == 'SUCCESS'){
				div.innerHTML = "<h4>Email Sent! Request ID is "+resultId+"<br> If you do not receive an email within 5 minutes, please double-check the email address above, and check your spam filter</h4>";
			}
			else if(json.statusMessage == "Parameter 'FullName' must be given a value.\n    "){
				div.innerHTML = "<h4>Request failed <br>You must enter your full name and email address <br> Please try again</h4>";
			}
			else{
				div.innerHTML = "<h4>Something has gone wrong <br> Contact train@safe.com and include the following:</h4><pre>"+JSON.stringify(json, undefined, 4)+"</pre>";
			}

			form.appendChild( hr );
			form.appendChild( div );
		}

		function submitJob() {
			// Create the the publishedParameters array, and a checkboxes object
			var params = { "publishedParameters" : [] };
			var publishedParameters = params.publishedParameters;
			var checkboxes = {};
			
			//Hide the request button so it doesn't get pressed again
			var button = document.getElementById("RequestButton");
			button.type = "hidden";
			
			//Show spinner
			var spinner = document.getElementById("spinner");
			spinner.type = "image";
			
			// Loop through the form elements and build the publishedParameters array
			for( var i = 0; i < form.elements.length; i++ ){
				var element = form.elements[i];
				var obj = { "name" : "", "value" : null }
				obj.name = element.name;
				if( element.type == "select" ) {
					obj.value = element[element.selectedIndex].value;
					publishedParameters.push( obj );
				} else if( element.type == "checkbox" ){
					if( element.checked ) {
						if( !checkboxes[element.name] ){
							checkboxes[element.name] = [];
						}
						checkboxes[element.name].push( element.value );
					}
				} else if( element.type != "hidden" && element.type != "button" ) {
					obj.value = element.value;
					publishedParameters.push( obj );
				}
			}

			// Add all grouped checkbox elements to the published parameters
			for( name in checkboxes ) {
				publishedParameters.push( { "name" : name, "value" : checkboxes[name] } );
			}

			// Submit Job to FME Server and run synchronously
			FMEServer.submitSyncJob( repository, workspace, params, showResults );
		}

	</script>
</body>
</html>
